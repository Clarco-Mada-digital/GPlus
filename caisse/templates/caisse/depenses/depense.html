{% extends 'layout/layout.html' %}
{% load static %}
{%load humanize %}

{% block title_page %}Détails des Dépenses{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- En-tête avec sélecteur de mois -->
    <div class="bg-white dark:bg-secondary rounded-2xl shadow-sm">
        <div class="flex flex-col md:flex-row justify-between items-center p-4">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4 md:mb-0">
                Détails des Dépenses par Employés
            </h2>
            <select id="moisSelect" 
                    class="w-full md:w-auto px-7 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300"
                    onchange="updateMonth(this.value)">
                {% for mois in mois_liste %}
                <option value="{{ mois.value }}" {% if mois.value == mois_selectionne %}selected{% endif %}>
                    {{ mois.label }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Table responsive -->
        <div class="overflow-x-auto">
            <div class="inline-block min-w-full align-middle">
                <div class="overflow-hidden">
                    <div class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">

                        <!-- Section des filtres -->
                        <div class="flex items-center flex-row justify-between text-black dark:text-white">
                            <form method="GET" action="{% url 'caisse:liste_entrees' %}" 
                                  class="hidden md:block p-2 bg-white dark:bg-secondary" 
                                  id="filter-form" 
                                  onsubmit="return false;">
                                <div class="flex items-center dark:bg-secondary rounded-xl space-x-4">
                                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 w-full">
                                        <!-- Sélecteur Employés -->
                                        <select name="employe"
                                                class="w-full md:w-auto py-2 border-none dark:bg-secondary focus:ring-0 rounded-lg"
                                                onchange="updateQueryParam([{ key: 'employe', value: this.value }])">
                                            <option value="">Employés</option>
                                            {% for employe in employes %}
                                            <option value="{{ employe.id }}" {% if request.GET.employe == employe.id|stringformat:"s" %}selected{% endif %}>
                                                {{ employe }}
                                            </option>
                                            {% endfor %}
                                        </select>
                    
                                        <div class="hidden md:block h-10 w-0.5 bg-gray-300"></div>
    
                                        <!-- Sélecteur Catégories -->
                                        <select name="categorie_emp"
                                                class="w-full md:w-auto py-2 border-none dark:bg-secondary focus:ring-0 rounded-lg"
                                                onchange="updateQueryParam([{ key: 'categorie_emp', value: this.value }])">
                                            <option value="">Catégories</option>
                                            {% for categorie in categories %}
                                            <option value="{{ categorie.categorie__id }}" {% if request.GET.categorie_emp == categorie.categorie__id|stringformat:"s" %}selected{% endif %}>
                                                {{ categorie.categorie__name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                    
                                        <div class="hidden md:block h-10 w-0.5 bg-gray-300"></div>
                    
                                        <!-- Bouton Reset -->
                                        <a href="?lignes={{ lignes_par_page }}"
                                           class="text-red px-3 py-2 hover:text-red-700 flex items-center justify-center md:justify-start space-x-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M23 4v6h-6"/>
                                                <path d="M1 20v-6h6"/>
                                                <path d="M3.51 9a9 9 0 0114.13-3.36L23 10M1 14l4.36 4.36A9 9 0 0020.49 15"/>
                                            </svg>
                                            <span>Reset</span>
                                        </a>
                                    </div>
                                </div>
                            </form>

                            <div class="flex flex-col gap-4 font-medium items-center justify-end pb-4 px-4">
                                <!-- Sélecteur pour le nombre de lignes par page -->
                                <form method="get" class="flex items-center space-x-2">
                                    <label for="lignes" class="hidden md:flex">Nombre de lignes :</label>
                                    <label for="lignes" class="md:hidden">Lignes:</label>
                                    <select name="lignes"
                                    class="border-none dark:bg-secondary focus:ring-0" id="lignes"
                                    onchange="updateQueryParam([{ key: 'lignes', value: this.value }])">
                                    <option value="5" {% if lignes_par_page == '5' %}selected{%endif%}>5</option>
                                    <option value="10" {% if lignes_par_page == '10' %}selected{% endif %}>10</option>
                                    <option value="15" {% if lignes_par_page == '15' %}selected{% endif %}>15</option>
                                    <option value="30" {% if lignes_par_page == '30' %}selected{% endif %}>30</option>
                                    <option value="100" {% if lignes_par_page == '100' %}selected{% endif %}>100</option>
                                    </select>
                                </form>
                        
                                <!-- Pagination -->
                                <div class="flex items-center font-medium space-x-2">
                                    <span class="hidden md:flex mx-2">Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}</span>
                                    <div class="flex space-x-2">
                                      {% if page_obj.has_previous %}
                                        <a
                                            onclick="updateQueryParam([{ key: 'page', value: 1 }])"
                                            style="cursor: pointer;"
                                            class="px-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                                height="24" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M19 12H5M12 5l-7 7 7 7" />
                                            </svg></a>
                                        <a
                                        onclick="updateQueryParam([{ key: 'page', value: {{ page_obj.previous_page_number }} }])"
                                        style="cursor: pointer;"
                                        class="px-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                                height="24" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M15 18l-6-6 6-6" />
                                            </svg>
                                        </a>
                                        {% else %}
                                        <a
                                            class="px-3 text-gray-400 cursor-not-allowed">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                                height="24" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M19 12H5M12 5l-7 7 7 7" />
                                            </svg></a>
                                        <a
                                        class="px-3 text-gray-400 cursor-not-allowed">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                                height="24" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M15 18l-6-6 6-6" />
                                            </svg>
                                        </a>
                                        {% endif %}
                                        <span class="md:hidden mx-2">{{ page_obj.number }}/{{ page_obj.paginator.num_pages }}</span>
                                        {% if page_obj.has_next %}
                                        <a
                                            onclick="updateQueryParam([{ key: 'page', value: {{ page_obj.next_page_number }} }])"
                                            style="cursor: pointer;"
                                            class="px-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                            height="24" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M9 6l6 6-6 6" />
                                            </svg>
                                        </a>
                                        <a
                                            onclick="updateQueryParam([{ key: 'page', value: {{ page_obj.paginator.num_pages }} }])"
                                            style="cursor: pointer;"
                                            class="px-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                                height="24" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M5 12h14M12 19l7-7-7-7" />
                                            </svg>
                                        </a>
                                        {% else %}
                                        <a
                                            class="px-3 text-gray-400 cursor-not-allowed">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                            height="24" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M9 6l6 6-6 6" />
                                            </svg>
                                        </a>
                                        <a
                                        class="px-3 text-gray-400 cursor-not-allowed">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                                height="24" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M5 12h14M12 19l7-7-7-7" />
                                            </svg>
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- En-têtes pour grand écran -->
                        <div class="hidden md:grid bg-gray-50 dark:bg-gray-700">
                            <div class="grid grid-cols-5 gap-2">
                                <div class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {% if request.GET.sort == 'employe' and request.GET.order == 'asc' %}
                                    <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort', value: 'employe' }], [{ key: 'order', value: 'desc' }])">Employé ⬇</a>
                                    {% elif request.GET.sort == 'employe' and request.GET.order == 'desc' %}
                                    <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort'}], [{ key: 'sort'}])">Employé ⬆</a>
                                    {% else %}
                                    <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort', value: 'employe' }], [{ key: 'order', value: 'asc' }])">Employé ⬆⬇</a>
                                    {% endif %}
                                </div>
                                <div class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {% if request.GET.sort == 'total_emp' and request.GET.order == 'asc' %}
                                    <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort', value: 'total_emp' }], [{ key: 'order', value: 'desc' }])">Total ⬇</a>
                                    {% elif request.GET.sort == 'total_emp' and request.GET.order == 'desc' %}
                                    <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort'}], [{ key: 'order'}])">Total ⬆</a>
                                    {% else %}
                                    <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort', value: 'total_emp' }], [{ key: 'order', value: 'asc' }])">Total ⬆⬇</a>
                                    {% endif %}
                                </div>
                                <div class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {% if request.GET.sort == 'categorie_emp' and request.GET.order == 'asc' %}
                                    <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort', value: 'categorie_emp' }], [{ key: 'order', value: 'desc' }])">Catégorie ⬇</a>
                                    {% elif request.GET.sort == 'categorie_emp' and request.GET.order == 'desc' %}
                                    <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort'}], [{ key: 'order'}])">Catégorie ⬆</a>
                                    {% else %}
                                    <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort', value: 'categorie_emp' }], [{ key: 'order', value: 'asc' }])">Catégorie ⬆⬇</a>
                                    {% endif %}
                                </div>
                                <div class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    {% if request.GET.sort == 'operation_emp' and request.GET.order == 'asc' %}
                                    <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort', value: 'operation_emp' }], [{ key: 'order', value: 'desc' }])">Opérations ⬇</a>
                                    {% elif request.GET.sort == 'operation_emp' and request.GET.order == 'desc' %}
                                    <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort'}], [{ key: 'order'}])">Opérations ⬆</a>
                                    {% else %}
                                    <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort', value: 'operation_emp' }], [{ key: 'order', value: 'asc' }])">Opérations ⬆⬇</a>
                                    {% endif %}
                                </div>
                                <div class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                    Actions
                                </div>
                            </div>
                        </div>

                        <!-- Données -->
                        <div class="divide-y divide-gray-200 dark:divide-gray-700">
                            {% for depense in page_obj %}
                            <!-- Version mobile -->
                            <div class="md:hidden p-4 space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Employé:</span>
                                    <span class="text-sm text-gray-900 dark:text-gray-300">
                                        {{ depense.beneficiaire }}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Total:</span>
                                    <span class="text-sm text-blue-600 dark:text-blue-400">
                                        Ar {{ depense.total_depenses|floatformat:0|intcomma }}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Catégorie:</span>
                                    <span class="text-sm text-gray-900 dark:text-gray-300">
                                        {{ depense.categorie_plus_depensee }}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Opérations:</span>
                                    <span class="text-sm text-gray-900 dark:text-gray-300">
                                        {{ depense.nombre_depenses }}
                                    </span>
                                </div>
                            </div>

                            <!-- Version desktop -->
                            <div class="hidden md:grid grid-cols-5 gap-2 hover:bg-gray-50 dark:hover:bg-gray-800">
                                <div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-300 flex items-center">
                                    {{ depense.beneficiaire }}
                                </div>
                                <div class="px-4 py-3 text-sm text-blue-600 dark:text-blue-400 text-right flex items-center justify-end">
                                    Ar {{ depense.total_depenses|floatformat:0|intcomma}}
                                </div>
                                <div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-300 text-center flex items-center justify-center">
                                    {{ depense.categorie_plus_depensee }}
                                </div>
                                <div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-300 text-right flex items-center justify-end">
                                    {{ depense.nombre_depenses }}
                                </div>
                                <div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-300 text-center flex items-center justify-center">
                                    <button class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">
                                        •••
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dépenses par Catégories -->
    <span id="details_by_categories"></span>
    <div class="bg-white dark:bg-secondary rounded-2xl shadow-sm mt-8 mb-8">
        <div class="p-4">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">
                Détails des Dépenses par Catégories
            </h2>
            
            <div class="overflow-x-auto">
                <div class="inline-block min-w-full align-middle">
                    <div class="overflow-hidden">
                        <div class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- En-têtes -->
                            <div class="hidden md:grid bg-gray-50 dark:bg-gray-700">
                                <div class="grid grid-cols-4 gap-2">
                                    <div class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                        {% if request.GET.sort == 'categorie_cat' and request.GET.order == 'asc' %}
                                        <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort', value: 'categorie_cat' }], [{ key: 'order', value: 'desc' }], [{ id: 'details_by_categories'}])">Catégorie ⬇</a>
                                        {% elif request.GET.sort == 'categorie_cat' and request.GET.order == 'desc' %}
                                        <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort'}], [{ key: 'order'}], [{ id: 'details_by_categories'}])">Catégorie ⬆</a>
                                        {% else %}
                                        <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort', value: 'categorie_cat' }], [{ key: 'order', value: 'asc' }], [{ id: 'details_by_categories'}])">Catégorie ⬆⬇</a>
                                        {% endif %}
                                    </div>
                                    <div class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                        {% if request.GET.sort == 'total_cat' and request.GET.order == 'asc' %}
                                        <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort', value: 'total_cat' }], [{ key: 'order', value: 'desc' }], [{ id: 'details_by_categories'}])">Total ⬇</a>
                                        {% elif request.GET.sort == 'total_cat' and request.GET.order == 'desc' %}
                                        <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort'}], [{ key: 'order'}], [{ id: 'details_by_categories'}])">Total ⬆</a>
                                        {% else %}
                                        <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort', value: 'total_cat' }], [{ key: 'order', value: 'asc' }], [{ id: 'details_by_categories'}])">Total ⬆⬇</a>
                                        {% endif %}
                                    </div>
                                    <div class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                        {% if request.GET.sort == 'operation_cat' and request.GET.order == 'asc' %}
                                        <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort', value: 'operation_cat' }], [{ key: 'order', value: 'desc' }], [{ id: 'details_by_categories'}])">Opérations ⬇</a>
                                        {% elif request.GET.sort == 'operation_cat' and request.GET.order == 'desc' %}
                                        <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort'}], [{ key: 'order'}], [{ id: 'details_by_categories'}])">Opérations ⬆</a>
                                        {% else %}
                                        <a style="cursor: pointer" onclick="updateQueryParam([{ key: 'sort', value: 'operation_cat' }], [{ key: 'order', value: 'asc' }], [{ id: 'details_by_categories'}])">Opérations ⬆⬇</a>
                                        {% endif %}
                                    </div>
                                    <div class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                        Actions
                                    </div>
                                </div>
                            </div>

                            <!-- Données -->
                            <div class="divide-y divide-gray-200 dark:divide-gray-700">
                                {% for depense in depenses_par_categorie %}
                                <!-- Version mobile -->
                                <div class="md:hidden p-4 space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Catégorie:</span>
                                        <span class="text-sm text-gray-900 dark:text-gray-300">
                                            {{ depense.categorie__name }}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Total:</span>
                                        <span class="text-sm text-blue-600 dark:text-blue-400">
                                            Ar {{ depense.total_depenses|floatformat:0|intcomma }}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Opérations:</span>
                                        <span class="text-sm text-gray-900 dark:text-gray-300">
                                            {{ depense.nombre_depenses }}
                                        </span>
                                    </div>
                                </div>

                                <!-- Version desktop -->
                                <div class="hidden md:grid grid-cols-4 gap-2 hover:bg-gray-50 dark:hover:bg-gray-800">
                                    <div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-300">
                                        {{ depense.categorie__name }}
                                    </div>
                                    <div class="px-4 py-3 text-sm text-blue-600 dark:text-blue-400 text-right">
                                        Ar {{ depense.total_depenses|floatformat:0|intcomma }}
                                    </div>
                                    <div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-300 text-right">
                                        {{ depense.nombre_depenses }}
                                    </div>
                                    <div class="px-4 py-3 text-sm text-center">
                                        <button class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">
                                            •••
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="grid grid-cols-1 gap-8">
        <!-- Graphique par Catégories -->
        <div class="bg-white dark:bg-secondary rounded-2xl shadow-sm p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-white">
                    Graphique par catégories
                </h2>
                {% comment %} <select id="graphiqueSelect"
                        class="px-4 py-2 rounded-lg bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-300 border border-gray-300 dark:border-gray-600"
                        onchange="updateGraphType(this.value)">
                    <option value="mensuel">Mensuel</option>
                    <option value="annuel">Annuel</option>
                </select> {% endcomment %}
            </div>
            <div style="height: 400px;">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <!-- Graphique Dépenses par année -->
        <div class="bg-white dark:bg-secondary rounded-2xl shadow-sm p-4">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">
                Dépenses par année
            </h2>
            <div class="xl:h-[500px] lg:h-[350px] md:h-[250px] transition-all duration-500">
                <canvas class="h-full w-full" id="yearlyExpensesChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

    let categoryChart;
    let yearlyExpensesChart;
    
    function updateMonth(mois) {
        const url = new URL(window.location);
        url.searchParams.set('mois', mois);
        window.location.href = url.toString();
    }

    function updateGraphType(type) {
        const url = new URL(window.location);
        url.searchParams.set('graph_type', type);
        window.location.href = url.toString();
    }

    function filterTableByCategory(category) {
        const tables = document.querySelectorAll('table tbody tr');
        
        tables.forEach(row => {
            const categoryCell = row.querySelector('td:first-child');
            if (!categoryCell) return;
            
            if (!category || categoryCell.textContent.trim() === category) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Mettre à jour le graphique
        updateChartByCategory(category);
    }

    function updateChartByCategory(category) {
        const chartData = {
            labels: [],
            data: [],
            colors: []
        };

        // Récupérer les données filtrées
        const tables = document.querySelectorAll('table tbody tr');
        tables.forEach(row => {
            const categoryCell = row.querySelector('td:first-child');
            const amountCell = row.querySelector('td:nth-child(2)');
            if (!categoryCell || !amountCell) return;

            const categoryName = categoryCell.textContent.trim();
            if (!category || categoryName === category) {
                chartData.labels.push(categoryName);
                // Convertir le montant en nombre (enlever "Ar" et les espaces)
                const amount = parseFloat(amountCell.textContent.replace('Ar', '').trim());
                chartData.data.push(amount);
                // Utiliser la même couleur que celle définie dans la vue
                const colorIndex = chartData.labels.length - 1;
                chartData.colors.push(colors[colorIndex % colors.length]);
            }
        });

        // Mettre à jour le graphique
        if (categoryChart) {
            categoryChart.data.labels = chartData.labels;
            categoryChart.data.datasets[0].data = chartData.data;
            categoryChart.data.datasets[0].backgroundColor = chartData.colors;
            categoryChart.update();
        }
    }

    // Définir les couleurs pour les catégories
    const colors = [
        '#396AFF', '#16DBCC', '#FF82AC', '#FFB800', '#4040FF',
        '#EC4899', '#8B5CF6', '#14B8A6', '#F97316', '#06B6D4'
    ];

    // Synchroniser les sélecteurs de mois
    const moisSelect = document.getElementById('moisSelect');
    const moisSelectCategories = document.getElementById('moisSelectCategories');
    
    if (moisSelect && moisSelectCategories) {
        moisSelectCategories.innerHTML = moisSelect.innerHTML;
        moisSelectCategories.value = moisSelect.value;
        
        moisSelectCategories.addEventListener('change', function() {
            updateMonth(this.value);
        });
    }
    
    // Préparer les données initiales
    const initialData = {
        labels: [{% for depense in depenses_par_categorie %}'{{ depense.categorie__name }}',{% endfor %}],
        data: [{% for depense in depenses_par_categorie %}{{ depense.total_depenses }},{% endfor %}]
    };

    function categoryChartConfig() {
        const isDarkMode = document.documentElement.classList.contains('dark');
        const fontColor = isDarkMode ? '#fff' : '#374151';
        const borderColor = isDarkMode ? '#374151' : '#e5e7eb';

        return {
            type: 'bar',
            data: {
                labels: initialData.labels,
                datasets: [{
                    label: 'Dépenses par Catégorie',
                    data: initialData.data,
                    backgroundColor: colors.slice(0, initialData.labels.length),
                    borderRadius: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        position: 'left',
                        ticks: {
                            callback: function(value) {
                                return 'Ar ' + value.toLocaleString('fr-FR');
                            },
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            color: fontColor
                        },
                        grid: {
                            color: 'rgba(200, 200, 200, 0.3)'
                        },
                        max: Math.max(...initialData.data) * 1.1
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            color: fontColor
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: {
                                size: 12
                            },
                            color: fontColor,
                            usePointStyle: true,
                            padding: 20,
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        
                                        return {
                                            text: `${label} ${percentage}%`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            fontColor: fontColor,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        titleColor: fontColor,
                        bodyColor: fontColor,
                        backgroundColor: isDarkMode ? '#1f2937' : '#fff',
                        borderColor: isDarkMode ? '#374151' : '#e5e7eb',
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${context.label}: ${percentage}% (Ar ${value.toLocaleString('fr-FR')})`;
                            }
                        }
                    }
                },
                layout: {
                    padding: {
                        top: 30,
                        bottom: 30,
                        left: 20,
                        right: 20
                    }
                },
                animation: {
                    duration: 0 // Désactive l'animation
                }
            }
        }
    }

    categoryChart = new Chart(document.getElementById('categoryChart').getContext('2d'), categoryChartConfig());

    // Limiter le nombre de catégories affichées
    const maxCategories = 10; // Nombre maximum de catégories à afficher
    if (categoryChart.data.labels.length > maxCategories) {
        categoryChart.data.labels = categoryChart.data.labels.slice(0, maxCategories);
        categoryChart.data.datasets[0].data = categoryChart.data.datasets[0].data.slice(0, maxCategories);
        categoryChart.data.datasets[0].backgroundColor = categoryChart.data.datasets[0].backgroundColor.slice(0, maxCategories);
    }

    function yearlyExpensesChartConfig() {
        const isDarkMode = document.documentElement.classList.contains('dark');
        const fontColor = isDarkMode ? '#fff' : '#374151';
        const borderColor = isDarkMode ? '#374151' : '#e5e7eb';

        return {
            type: 'line',
            data: {
                labels: [{% for depense in depenses_par_annee %}'{{ depense.year|date:"Y" }}',{% endfor %}],
                datasets: [{
                    label: 'Dépenses par année',
                    data: [{% for depense in depenses_par_annee %}{{ depense.total_depenses }},{% endfor %}],
                    borderColor: '#EDA10D',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' Ar';
                            },
                            color: fontColor
                        }
                    },
                    x: {
                        beginAtZero: true,
                        ticks: {
                            color: fontColor
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false,
                    }
                }
            }
        }
    }
    
    // Graphique Dépenses par année
    const ctxYearly = document.getElementById('yearlyExpensesChart').getContext('2d');
    const ctxYearlyParent = document.getElementById('yearlyExpensesChart').parentNode;
    
    yearlyExpensesChart = new Chart(ctxYearly, yearlyExpensesChartConfig());

    // Adapter les graphiques pour mobile de manière dynamique
    function adaptCharts() {
        if (window.innerWidth < 770) {
        // Graphique Dépenses par Catégorie
        categoryChart.options.scales.y.ticks.font.size = 10; // Réduire la taille de la police des ticks
        categoryChart.options.scales.x.ticks.font.size = 10; // Réduire la taille de la police des ticks
        categoryChart.options.plugins.legend.display = false; // Masquer la légende

        ctxYearlyParent.style.display = 'flex'; // Utiliser flexbox pour centrer
        ctxYearlyParent.style.justifyContent = 'center'; // Centrer horizontalement
        ctxYearlyParent.style.alignItems = 'center'; // Centrer verticalement
        } else {
        ctxYearlyParent.removeAttribute('style');
        categoryChart.options.plugins.legend.display = true; // Afficher la légende
        }

        categoryChart.update();
        yearlyExpensesChart.update();
    }

    // Ajouter un écouteur d'événement pour redimensionner la fenêtre
    window.addEventListener('resize', adaptCharts);
    
    // Initialiser le filtre de catégorie
    const categorieFilter = document.getElementById('categorieFilter');
    if (categorieFilter) {
        const urlParams = new URLSearchParams(window.location.search);
        const selectedCategory = urlParams.get('categorie');
        if (selectedCategory) {
            categorieFilter.value = selectedCategory;
            filterTableByCategory(selectedCategory);
        }
    }

    // Écouter les changements de mode
    function changeThemeCharts() {
        setTimeout(() => {
            // Graphique Dépense par Catégorie
            if (categoryChart) {
                categoryChart.destroy();
            }
            categoryChart = new Chart(document.getElementById('categoryChart'), categoryChartConfig());
            // Graphique Dépense par Année
            if (yearlyExpensesChart) {
                yearlyExpensesChart.destroy();
            }
            yearlyExpensesChart = new Chart(ctxYearly, yearlyExpensesChartConfig());
            adaptCharts();
        });
    }
    
    // Appeler la fonction lors du chargement de la page
    adaptCharts();

</script>

<script>
    // Fonction pour mettre à jour le paramètre de requête dans l'URL et recharger la page
    function updateQueryParam(...params) {
        const url = new URL(window.location.href);
        params.flat().forEach(param => {
            if (param.value) {
                url.searchParams.set(param.key, param.value);
            } else {
                url.searchParams.delete(param.key);
            }
            if (param.id) {
                url.hash = `#${param.id}`;
            }
        });
        window.location.href = url.toString();
    }
</script>
{% endblock %}
