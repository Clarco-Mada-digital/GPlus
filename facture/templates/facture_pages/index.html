{% extends 'layouts/facture_layout.html' %} 
{% block title_page %} Facture & Devis {% endblock title_page %} 
{% block content %}

<div x-data="factDataComponent()" x-init="init()" x-cloak >

  {% comment %} Button toogle devis et facture {% endcomment %}
  <div class="flex w-full items-center justify-center">
    <div class="my-4 inline-flex rounded-md shadow-sm" role="group">
      <button x-on:click="facture_view = true; saveFactView()" type="button" :class="facture_view ? 'inline-flex items-center px-4 py-2 text-sm font-medium text-gray-900  border border-blue-200 rounded-s-lg hover:bg-blue-300 hover:text-blue-700 focus:z-10 focus:text-blue-700 dark:bg-blue-800 dark:border-blue-700 dark:text-white dark:hover:text-white dark:hover:bg-gray-700 dark:focus:ring-blue-500 dark:focus:text-white' : 'inline-flex items-center px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-s-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:text-blue-700 dark:bg-gray-800 dark:border-gray-700 dark:text-white dark:hover:text-white dark:hover:bg-gray-700 dark:focus:ring-blue-500 dark:focus:text-white'">
        <svg class="w-3 h-3 me-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 0a10 10 0 1 0 10 10A10.011 10.011 0 0 0 10 0Zm0 5a3 3 0 1 1 0 6 3 3 0 0 1 0-6Zm0 13a8.949 8.949 0 0 1-4.951-1.488A3.987 3.987 0 0 1 9 13h2a3.987 3.987 0 0 1 3.951 3.512A8.949 8.949 0 0 1 10 18Z"/>
        </svg>
        Facture
      </button>
      <button x-on:click="facture_view = false; saveFactView()" type="button" :class="!facture_view ? 'inline-flex items-center px-4 py-2 text-sm font-medium text-gray-900  border border-blue-200 rounded-e-lg hover:bg-blue-300 hover:text-blue-700 focus:z-10 focus:text-blue-700 dark:bg-blue-800 dark:border-blue-700 dark:text-white dark:hover:text-white dark:hover:bg-gray-700 dark:focus:ring-blue-500 dark:focus:text-white' : 'inline-flex items-center px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-e-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:text-blue-700 dark:bg-gray-800 dark:border-gray-700 dark:text-white dark:hover:text-white dark:hover:bg-gray-700 dark:focus:ring-blue-500 dark:focus:text-white'">
        <svg class="w-3 h-3 me-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
          <path d="M14.707 7.793a1 1 0 0 0-1.414 0L11 10.086V1.5a1 1 0 0 0-2 0v8.586L6.707 7.793a1 1 0 1 0-1.414 1.414l4 4a1 1 0 0 0 1.416 0l4-4a1 1 0 0 0-.002-1.414Z"/>
          <path d="M18 12h-2.55l-2.975 2.975a3.5 3.5 0 0 1-4.95 0L4.55 12H2a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2Zm-3 5a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/>
        </svg>
        Devis
      </button>
    </div>
  </div>

  {% comment %} View facture {% endcomment %}
  <div x-show="facture_view" x-transition.duration.500ms  class="container mx-auto px-4 py-8">
    <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
      <div class="flex flex-column sm:flex-row flex-wrap space-y-4 sm:space-y-0 items-center justify-between pb-4">
        <div>
          <form id="fact_filtre-form" method="GET">
          <select id="fact_filtre_mois" name="filtre" class="text-gray-500 bg-white border border-gray-300 w-40 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-3 py-1.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700">
            <option value="" selected disabled hidden>
              Filtre par mois
            </option>
            {% for mois in fact_mois_filtrable|slice:5 %}
              <option 
              value="{{ mois.id }}">
                {{ mois.nom }}
              </option>
            {% endfor %}
          </select>
          <select id="fact_filtre_annee" name="filtre" class="text-gray-500 bg-white border border-gray-300 w-40 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-3 py-1.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700">
            <option value="" selected disabled hidden>
              Filtre par année
            </option>          
            {% for annee in fact_annee_filtrable|slice:5 %}
              <option value="{{ annee.id }}">
                {{ annee.nom }}
              </option>
            {% endfor %}
          </select>        
          <button type="button" onclick="window.location.href=window.location.pathname" class="text-gray-500 bg-white border border-gray-300 w-40 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-3 py-1.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700">
            Réinitialiser
          </button>
          </form>        
          </div>
        <label for="table-search" class="sr-only">Rechercher</label>
        <div class="relative">
          <div
            class="absolute inset-y-0 left-0 rtl:inset-r-0 rtl:right-0 flex items-center ps-3 pointer-events-none"
          >
            <svg
              class="w-5 h-5 text-gray-500 dark:text-gray-400"
              aria-hidden="true"
              fill="currentColor"
              viewBox="0 0 20 20"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                fill-rule="evenodd"
                d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                clip-rule="evenodd"
              ></path>
            </svg>
          </div>
          <input
            type="text"
            id="table-search"
            class="block p-2 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg w-80 bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
            placeholder="Rechercher des articles"
          />
        </div>
      </div>
      <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
        <thead class="text-gray-700 capitalize bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
          <tr>
            <th scope="col" class="p-4">
              <div class="flex items-center">
                <input
                  id="checkbox-all-search"
                  type="checkbox"
                  class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"/>
                <label for="checkbox-all-search" class="sr-only">checkbox</label>
              </div>
            </th>
            <th scope="col" class="px-6 py-3">Ref.</th>
            <th scope="col" class="px-6 py-3">Intitulé du facture</th>
            <th scope="col" class="px-6 py-3">Reglement</th>
            <th scope="col" class="px-6 py-3">Condition</th>
            <th scope="col" class="px-6 py-3">Etat</th>
            <th scope="col" class="px-6 py-3">Montant</th>
            <th scope="col" class="px-6 py-3">Action</th>
          </tr>
        </thead>
        <tbody>          
          
          {% for facture in factures %}
          <tr class="bg-white border-b dark:bg-gray-800 even:dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50" data-mois="{{ facture.date_facture.month }}">
            <td colspan="8" class="w-4 p-4 text-center text-blue-500 font-bold text-xl capitalize">
              {{ facture.date_facture|date:"F" }}
            </td>
          </tr>
          <tr
            class="bg-white border-b odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
            <td class="w-4 p-4">
              <div class="flex items-center">
                <input
                  id="checkbox-table-search-1"
                  type="checkbox"
                  class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                />
                <label for="checkbox-table-search-1" class="sr-only"
                  >checkbox</label
                >
              </div>
            </td>
            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
              {{ facture.ref }}
            </th>
            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
              {{ facture.intitule }}
            </th>
            <td class="px-6 py-4">{{ facture.reglement }}</td>
            <td class="px-6 py-4">{{ facture.condition }}</td>
            <td class="px-6 py-4">{{ facture.etat_facture }}</td>
            <td class="px-6 py-4">Ar {{ facture.montant }}</td>
            <td class="px-6 py-4 flex items-center">
              <a href="{% url 'facture:edit_facture' facture.id %}" target='_blank' type="button" class="px-1 py-2 text-sm font-medium text-center inline-flex items-center text-white rounded-lg">
                <svg class="w-7 h-7 text-blue-700 me-2" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M5 21q-.825 0-1.412-.587T3 19V5q0-.825.588-1.412T5 3h8.925l-2 2H5v14h14v-6.95l2-2V19q0 .825-.587 1.413T19 21zm4-6v-4.25l9.175-9.175q.3-.3.675-.45t.75-.15q.4 0 .763.15t.662.45L22.425 3q.275.3.425.663T23 4.4t-.137.738t-.438.662L13.25 15zM21.025 4.4l-1.4-1.4zM11 13h1.4l5.8-5.8l-.7-.7l-.725-.7L11 11.575zm6.5-6.5l-.725-.7zl.7.7z"/></svg>
              </a>
              <button data-modal-target="popup-modal-{{ facture.id }}" data-modal-toggle="popup-modal-{{ facture.id }}" type="button" class="px-1 py-2 text-sm font-medium text-center inline-flex items-center text-white rounded-lg">
                <svg class="w-7 h-7 text-red/70 me-2" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M7 21q-.825 0-1.412-.587T5 19V6q-.425 0-.712-.288T4 5t.288-.712T5 4h4q0-.425.288-.712T10 3h4q.425 0 .713.288T15 4h4q.425 0 .713.288T20 5t-.288.713T19 6v13q0 .825-.587 1.413T17 21zM17 6H7v13h10zm-7 11q.425 0 .713-.288T11 16V9q0-.425-.288-.712T10 8t-.712.288T9 9v7q0 .425.288.713T11 17m4 0q.425 0 .713-.288T15 16V9q0-.425-.288-.712T14 8t-.712.288T13 9v7q0 .425.288.713T14 17M7 6v13z"/></svg>
              </button>
              <button data-modal-target="popup-modal-facture" data-modal-toggle="popup-modal-facture" type="button" class="px-1 py-2 text-sm font-medium text-center inline-flex items-center text-white rounded-lg">
                <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m19.675 20.375l.7-.7L18.5 17.8V15h-1v3.2zM18 23q-2.075 0-3.537-1.463T13 18t1.463-3.537T18 13t3.538 1.463T23 18t-1.463 3.538T18 23M7 9h10V7H7zm4.675 12H5q-.825 0-1.412-.587T3 19V5q0-.825.588-1.412T5 3h14q.825 0 1.413.588T21 5v6.7q-.725-.35-1.463-.525T18 11q-.275 0-.513.012t-.487.063V11H7v2h6.125q-.45.425-.812.925T11.675 15H7v2h4.075q-.05.25-.062.488T11 18q0 .825.15 1.538T11.675 21"/></svg>
              </button>
            </td>
          </tr>

          {% comment %} Modal suppression {% endcomment %}
          <div id="popup-modal-{{ facture.id }}" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
            <div class="relative p-4 w-full max-w-md max-h-full">
                <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
                    <button type="button" class="absolute top-3 end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="popup-modal-{{ facture.id }}">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                        </svg>
                        <span class="sr-only">Fermer</span>
                    </button>
                    <div class="p-4 md:p-5 text-center">
                        <svg class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                        </svg>
                        <h3 class="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400">Êtes-vous sûr de vouloir supprimer ce facture ref: {{ facture.ref }}?</h3>
                        <a href="{% url 'facture:del_facture' facture.id %}" class="text-white bg-red/60 dark:bg-red/60 hover:bg-red/80 dark:hover:bg-red/80 focus:ring-4 focus:outline-none focus:ring-red/30 dark:focus:ring-red/80 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center me-2">
                            Oui, supprimer
                        </a>
                        <button data-modal-hide="popup-modal-{{ facture.id }}" type="button" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600">
                            Non, annuler
                        </button>
                    </div>
                </div>
            </div>
          </div>
          
          {% endfor %}     
        </tbody>
      </table>
      <nav class="flex items-center flex-column flex-wrap md:flex-row justify-between py-5" aria-label="Table navigation">
          <span class="text-sm font-normal text-gray-500 dark:text-gray-400 mb-4 md:mb-0 block w-full md:inline md:w-auto">Affichage <span class="font-semibold text-gray-900 dark:text-white">1-8</span> sur <span class="font-semibold text-gray-900 dark:text-white">1000</span></span>
          <ul class="inline-flex -space-x-px rtl:space-x-reverse text-sm h-8">
              <li>
                  <a href="#" class="flex items-center justify-center px-3 h-8 ms-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-s-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">Prev</a>
              </li>
              <li>
                  <a href="#" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">1</a>
              </li>
              <li>
                  <a href="#" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">2</a>
              </li>
              <li>
                  <a href="#" aria-current="page" class="flex items-center justify-center px-3 h-8 text-blue-600 border border-gray-300 bg-blue-50 hover:bg-blue-100 hover:text-blue-700 dark:border-gray-700 dark:bg-gray-700 dark:text-white">3</a>
              </li>
              <li>
                  <a href="#" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">4</a>
              </li>
              <li>
                  <a href="#" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">5</a>
              </li>
              <li>
          <a href="#" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 rounded-e-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">Suiv</a>
              </li>
          </ul>
      </nav>
    </div>
  </div>
  
  {% comment %} Modal facture view {% endcomment %}
  <div id="popup-modal-facture" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-9/12 max-h-full mx-auto">
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <button type="button" class="absolute top-3 end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="popup-modal-facture">
                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                </svg>
                <span class="sr-only">Fermer</span>
            </button>
            <div class="p-4 md:p-5">
              <!-- Prévisualisation de la facture -->
              <div class="p-4" id="preview-facture">
                <h2 class="text-lg font-bold mb-4 dark:text-white">Prévisualisation de la facture</h2>
                <div class="bg-gray-700 dark:bg-gray-900 p-10 shadow-md rounded">
                  <div class="flex justify-center items-center mb-10">
                    <img src="/static/images/logo mada-digital.png" alt="profil image" class="w-32 h-32 mb-3 rounded-full shadow-lg object-cover">
                  </div>
                  <div class="flex justify-between items-center mb-10">
                    <div>
                      {% comment %} <h3 class="text-xl font-bold mb-2 dark:text-gray-400">Info client</h3> {% endcomment %}
                      <p class="text-xl dark:text-gray-400">Nom d'entreprise : <span>MADA-Digital</span></p>
                      <p class="text-xl dark:text-gray-400">Nom : <span>{{ user.first_name }} {{ user.last_name }}</span></p>
                      <p class="text-xl dark:text-gray-400">Adresse : <span>12 rue de la boule</span></p>
                      <p class="text-xl dark:text-gray-400">Code postal : <span>75010 - Paris</span></p>
                      <p class="text-xl dark:text-gray-400">N° NIF : <span>12345678901234</span></p>
                      <p class="text-xl dark:text-gray-400">N° STAT : <span>12345678901234</span></p>
                    </div>
                    <div>
                      <textarea x-show="client_desc_facture" id="message" rows="6" cols="40" name="description_facture" class="block p-2.5 w-full text-xl text-gray-900 bg-transparent border-none dark:bg-transparent dark:placeholder-gray-400 dark:text-gray-400" style="resize: none;" disabled x-text="client_desc_facture"></textarea>
                      {% comment %} <h3 class="text-xl font-bold mb-2 dark:text-gray-400">Info facture</h3> {% endcomment %}
                      <div x-show="!client_desc_facture">
                        <p class="text-xl dark:text-gray-400">Nom d'entreprise : <span x-text="client_comercial_name"></span></p>
                        <p class="text-xl dark:text-gray-400">Nom du client : <span x-text="client_name"></span></p>
                        <p class="text-xl dark:text-gray-400">address du client : <span x-text="client_address"></span></p>
                        <p class="text-xl dark:text-gray-400">Code postal : <span x-text="client_code_postal"></span> - <span x-text="client_ville"></span></p>
                        <p class="text-xl dark:text-gray-400">N° NIF : <span>12345678901234</span></p>
                        <p class="text-xl dark:text-gray-400">N° STAT : <span>12345678901234</span></p>         
                        <p class="text-xl dark:text-gray-400"><span>{{ facture.client.description_facture|safe }}</span></p> 
                      </div>
                    </div>
                  </div>
                  <div class="mb-4 mt-10">
                    {% comment %} <h3 class="text-xl font-bold mb-2 dark:text-gray-400">Détail du facture</h3> {% endcomment %}
                    <p class="text-emerald-800 text-2xl dark:text-gray-400">Facture N° : <span x-text="facture_ref"></span></p>
                    <div class="flex items-center justify-start">
                      <p class="text-xl dark:text-gray-400">Date d'emission : <span x-text="facture_emission_date"></span></p>
                      <p class="text-xl dark:text-gray-400 ml-40">Règlement : <span x-text="facture_reglement"></span></p>
                    </div>
            
                    {% comment %} Tableau details de facture {% endcomment %}
                    <div class="relative overflow-x-auto shadow-md sm:rounded-lg mt-5">
                      <table class="w-full border border-gray-200 rounded-md dark:border-gray-700 text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
                          <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                              <tr>
                                  <th scope="col" class="px-6 py-3">
                                      Désignation
                                  </th>
                                  <th scope="col" class="px-6 py-3">
                                      <div class="flex items-center">
                                          Prix unitaire
                                      </div>
                                  </th>
                                  <th scope="col" class="px-6 py-3">
                                      <div class="flex items-center">
                                          Quantité
                                      </div>
                                  </th>
                                  <th scope="col" class="px-6 py-3 text-right">
                                      <div class="flex items-center">
                                          Montant HT
                                      </div>
                                  </th>
                              </tr>
                          </thead>
                          <tbody id="facture-services-table-body">
                          <template x-for="service in facture_services">
                            {% comment %} Liste des services du facture ici {% endcomment %}
                            <tr class="article-row">
                              <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white" x-text="service.description">
                                  
                              </th>
                              <td class="px-6 py-4 article-prix" x-text="service.prix">
                                  
                              </td>
                              <td class="px-6 py-4 article-quantite" data-value="service.quantite" x-text="service.quantite">
                              </td>
                              <td class="px-6 py-4 article-total" x-text="parseFloat(service.prix) * parseFloat(service.quantite)">
                              </td>
                            </tr>
                          </template>
                          </tbody>
                          <tfoot class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="row" class="px-6 py-4">
                                </th>
                                <th scope="row" class="px-6 py-4">
                                </th>
                                <th scope="row" class="px-6 py-4">
                                </th>
                                <th scope="row" class="px-6 py-2 text text-2xl font-bold text-gray-700 dark:text-gray-200">
                                    <div class="font-bold" id="total-montant" x-text="facture_sous_total">
                                        {% comment %} {{ facture.montant|floatformat }} Ar {% endcomment %}
                                    </div>
                                </th>
                            </tr>
                        </tfoot>
                      </table>
                      <!-- Total et Taxes -->
                      <div class="mb-8 mt-8">
                        <div class="w-full md:w-1/2 ml-auto">
                          <div class="grid grid-cols-2 gap-4">
                            <div class="text-right font-bold text-gray-700 dark:text-gray-200">Sous-total:</div>
                            <div class="text-right text-gray-700 dark:text-gray-200" id="sous-total" x-text="facture_sous_total">0.00 Ar</div>                              
                            <div :class="!facture_with_tva ? '' : 'line-through'" class="text-right font-bold text-gray-700 dark:text-gray-200" id="tva-label" class="">TVA (20%):</div>
                            <div :class="!facture_with_tva ? '' : 'line-through'" class="text-right text-gray-700 dark:text-gray-200" id="tva" x-text="facture_tva">0.00 Ar</div>
                            <div class="text-right font-bold text-lg text-gray-700 dark:text-gray-200">Total:</div>
                            <div class="text-right text-lg text-gray-700 dark:text-gray-200" id="total" x-text="facture_montant">0.00 Ar</div>
                            <input class="hidden" type="number" name="montant" id="total_input" value="0.00" >
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        </div>
    </div>
  </div>

  {% comment %} View Devis {% endcomment %}
  <div x-show="!facture_view" x-transition.duration.500ms  class="container mx-auto px-4 py-8">
    <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
      <div class="flex flex-column sm:flex-row flex-wrap space-y-4 sm:space-y-0 items-center justify-between pb-4">
        <div>
          <form id="dev_filtre-form" method="GET">
            <select id="dev_filtre_mois" name="filtre" class="text-gray-500 bg-white border border-gray-300 w-40 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-3 py-1.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700">
              <option value="" selected disabled hidden>
                Filtre par mois
              </option>
              {% for mois in dev_mois_filtrable|slice:5 %}
                <option 
                  selected="selected" if dev_mois_filtre == mois.id else ""
                   value="{{ mois.id }}">
                  {{ mois.nom }}
                </option>
              {% endfor %}
            </select>
            <select id="dev_filtre_annee" name="filtre" class="text-gray-500 bg-white border border-gray-300 w-40 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-3 py-1.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700">
              <option value="" selected disabled hidden>
                Filtre par année
              </option>          
              {% for annee in dev_annee_filtrable|slice:5 %}
                <option 
                  selected if dev_annee_filtre == mois.id else ""
                  value="{{ annee.id }}">                
                  {{ annee.nom }}
                </option>
              {% endfor %}
            </select>        
            <button type="button" onclick="window.location.href=window.location.pathname" class="text-gray-500 bg-white border border-gray-300 w-40 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-3 py-1.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700">
              Réinitialiser
            </button>
          </form>        
          </div>
        <label for="table-search" class="sr-only">Rechercher</label>
        <div class="relative">
          <div
            class="absolute inset-y-0 left-0 rtl:inset-r-0 rtl:right-0 flex items-center ps-3 pointer-events-none"
          >
            <svg
              class="w-5 h-5 text-gray-500 dark:text-gray-400"
              aria-hidden="true"
              fill="currentColor"
              viewBox="0 0 20 20"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                fill-rule="evenodd"
                d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                clip-rule="evenodd"
              ></path>
            </svg>
          </div>
          <input
            type="text"
            id="table-search"
            class="block p-2 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg w-80 bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
            placeholder="Rechercher des articles"
          />
        </div>
      </div>
      <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
        <thead class="text-gray-700 capitalize bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
          <tr>
            <th scope="col" class="p-4">
              <div class="flex items-center">
                <input
                  id="checkbox-all-search"
                  type="checkbox"
                  class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"/>
                <label for="checkbox-all-search" class="sr-only">checkbox</label>
              </div>
            </th>
            <th scope="col" class="px-6 py-3">Ref.</th>
            <th scope="col" class="px-6 py-3">Intitulé du devis</th>
            <th scope="col" class="px-6 py-3">Reglement</th>
            <th scope="col" class="px-6 py-3">Condition</th>
            <th scope="col" class="px-6 py-3">Montant</th>
            <th scope="col" class="px-6 py-3">Action</th>
          </tr>
        </thead>
        <tbody>
          
          {% for dev in devis %}
          <tr
            class="bg-white border-b dark:bg-gray-800 even:dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50" data-dev-mois="{{ dev.date_facture.month }}">
            <td colspan="7" class="w-4 p-4 text-center text-blue-500 font-bold text-xl capitalize">
              {{ dev.date_facture|date:"F" }}
            </td>
          </tr>
          <tr
            class="bg-white border-b odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
            <td class="w-4 p-4">
              <div class="flex items-center">
                <input
                  id="checkbox-table-search-1"
                  type="checkbox"
                  class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                />
                <label for="checkbox-table-search-1" class="sr-only"
                  >checkbox</label
                >
              </div>
            </td>
            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
              {{ dev.ref }}
            </th>
            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
              {{ dev.intitule }}
            </th>
            <td class="px-6 py-4">{{ dev.reglement }}</td>
            <td class="px-6 py-4">{{ dev.condition }}</td>
            <td class="px-6 py-4">Ar {{ dev.montant }}</td>
            <td class="px-6 py-4 flex items-center">
              <a href="{% url 'facture:edit_facture' dev.id %}" target='_blank' type="button" class="px-1 py-2 text-sm font-medium text-center inline-flex items-center text-white rounded-lg">
                <svg class="w-7 h-7 text-blue-700 me-2" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M5 21q-.825 0-1.412-.587T3 19V5q0-.825.588-1.412T5 3h8.925l-2 2H5v14h14v-6.95l2-2V19q0 .825-.587 1.413T19 21zm4-6v-4.25l9.175-9.175q.3-.3.675-.45t.75-.15q.4 0 .763.15t.662.45L22.425 3q.275.3.425.663T23 4.4t-.137.738t-.438.662L13.25 15zM21.025 4.4l-1.4-1.4zM11 13h1.4l5.8-5.8l-.7-.7l-.725-.7L11 11.575zm6.5-6.5l-.725-.7zl.7.7z"/></svg>
              </a>
              <button data-modal-target="popup-modal-{{ dev.id }}" data-modal-toggle="popup-modal-{{ dev.id }}" type="button" class="px-1 py-2 text-sm font-medium text-center inline-flex items-center text-white rounded-lg focus:outline-none">
                <svg class="w-7 h-7 text-red/70 me-2" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M7 21q-.825 0-1.412-.587T5 19V6q-.425 0-.712-.288T4 5t.288-.712T5 4h4q0-.425.288-.712T10 3h4q.425 0 .713.288T15 4h4q.425 0 .713.288T20 5t-.288.713T19 6v13q0 .825-.587 1.413T17 21zM17 6H7v13h10zm-7 11q.425 0 .713-.288T11 16V9q0-.425-.288-.712T10 8t-.712.288T9 9v7q0 .425.288.713T11 17m4 0q.425 0 .713-.288T15 16V9q0-.425-.288-.712T14 8t-.712.288T13 9v7q0 .425.288.713T14 17M7 6v13z"/></svg>
              </button>
              <button @click="getFactureValue('{{dev.id}}')" data-modal-target="popup-modal-facture" data-modal-toggle="popup-modal-facture" type="button" class="px-1 py-2 text-sm font-medium text-center inline-flex items-center text-white rounded-lg">
                <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m19.675 20.375l.7-.7L18.5 17.8V15h-1v3.2zM18 23q-2.075 0-3.537-1.463T13 18t1.463-3.537T18 13t3.538 1.463T23 18t-1.463 3.538T18 23M7 9h10V7H7zm4.675 12H5q-.825 0-1.412-.587T3 19V5q0-.825.588-1.412T5 3h14q.825 0 1.413.588T21 5v6.7q-.725-.35-1.463-.525T18 11q-.275 0-.513.012t-.487.063V11H7v2h6.125q-.45.425-.812.925T11.675 15H7v2h4.075q-.05.25-.062.488T11 18q0 .825.15 1.538T11.675 21"/></svg>
              </button>
            </td>
          </tr>          
          
          {% comment %} Modal suppression {% endcomment %}
          <div id="popup-modal-{{ dev.id }}" tabindex="-1" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
            <div class="relative p-4 w-full max-w-md max-h-full">
                <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
                    <button type="button" class="absolute top-3 end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="popup-modal-{{ dev.id }}">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                        </svg>
                        <span class="sr-only">Fermer</span>
                    </button>
                    <div class="p-4 md:p-5 text-center">
                        <svg class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                        </svg>
                        <h3 class="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400">Êtes-vous sûr de vouloir supprimer ce devis ref: {{ dev.ref }}?</h3>
                        <a href="{% url 'facture:del_facture' dev.id %}" class="text-white bg-red/60 dark:bg-red/60 hover:bg-red/80 dark:hover:bg-red/80 focus:ring-4 focus:outline-none focus:ring-red/30 dark:focus:ring-red/80 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center me-2">
                            Oui, supprimer
                        </a>
                        <button data-modal-hide="popup-modal-{{ dev.id }}" type="button" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600">
                            Non, annuler
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        </tbody>
      </table>
      <nav class="flex items-center flex-column flex-wrap md:flex-row justify-between py-5" aria-label="Table navigation">
          <span class="text-sm font-normal text-gray-500 dark:text-gray-400 mb-4 md:mb-0 block w-full md:inline md:w-auto">Affichage <span class="font-semibold text-gray-900 dark:text-white">1-8</span> sur <span class="font-semibold text-gray-900 dark:text-white">1000</span></span>
          <ul class="inline-flex -space-x-px rtl:space-x-reverse text-sm h-8">
              <li>
                  <a href="#" class="flex items-center justify-center px-3 h-8 ms-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-s-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">Prev</a>
              </li>
              <li>
                  <a href="#" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">1</a>
              </li>
              <li>
                  <a href="#" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">2</a>
              </li>
              <li>
                  <a href="#" aria-current="page" class="flex items-center justify-center px-3 h-8 text-blue-600 border border-gray-300 bg-blue-50 hover:bg-blue-100 hover:text-blue-700 dark:border-gray-700 dark:bg-gray-700 dark:text-white">3</a>
              </li>
              <li>
                  <a href="#" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">4</a>
              </li>
              <li>
                  <a href="#" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">5</a>
              </li>
              <li>
          <a href="#" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 rounded-e-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">Suiv</a>
              </li>
          </ul>
      </nav>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js" defer></script>
<script>
  // Alpine.js  
  function factDataComponent(){
    return {
      client_comercial_name: '',
      client_address: '',
      client_code_postal: '2343',
      client_ville: 'Paris',
      client_name: '',
      client_email: '',
      client_desc_facture: '',
      facture_ref: '',
      facture_intitule: '',
      facture_emission_date: '',
      facture_reglement: '',
      facture_etat: '',
      facture_montant: '',
      facture_condition: '',
      facture_description: '',
      facture_with_tva: '',
      facture_sous_total: '',
      facture_services: '',
      facture_view: 'true',
      mois_actuel:'',
      sousTotal: 0,
      facture_tva: 0,
      init(){
        // Charger les données depuis localStorage
        this.facture_view = localStorage.getItem('facture_view') === 'true';
      },

      calculerSousTotal(totalTTC, tva=0.20) {
        const tauxTVA = tva; // 20%
        const sousTotal = totalTTC / (1 + tauxTVA);
        return sousTotal;
      },

      getFactureValue(id) {
        // Récupérer l'URL de manière sécurisée
        const url = "{% url 'facture:one_facture' %}";

        fetch(`${url}?id=${id}`, {
            method: 'GET',
        })
        .then(response => {
          if (response.ok) {
              // Si la requête a réussi, convertir la réponse en JSON
              return response.json(); // Retourne une promesse
          } else {
              // Si la requête a échoué, affichez une erreur
              throw new Error('Une erreur s\'est produite lors de l\'enregistrement du service.');
          }
        })
        .then(data => {
          // Ici, vous pouvez utiliser les données de la facture
          this.client_comercial_name = data.client_comercial_name;
          this.client_address = data.client_address;
          this.client_code_postal = '2343';
          this.client_ville = 'Paris';
          this.client_name = data.client_name;
          this.client_email = data.client_email;
          this.client_desc_facture = data.client_desc_facture;
          this.facture_ref = data.facture_ref;
          this.facture_intitule = data.facture_intitule;
          this.facture_emission_date = data.facture_emission_date;
          this.facture_reglement = data.facture_reglement;
          this.facture_etat = data.facture_etat;
          this.facture_montant = `${data.facture_montant} Ar`;
          this.facture_condition = data.facture_condition;  
          this.facture_with_tva = data.facture_with_tva;
          let services = data.facture_services;
          this.facture_services = JSON.parse(services);          
          tva = this.facture_with_tva ? 0 : 0.20;
          
          this.facture_sous_total = `${this.calculerSousTotal(parseFloat(this.facture_montant), tva)} Ar`;
          this.facture_tva = `${parseFloat(this.facture_sous_total) * tva} Ar`;
          // Fermez le modal ou effectuez d'autres actions avec les données
          // window.location.reload(); // Décommentez si vous souhaitez recharger la page
        })
        .catch(error => {
            // Gérer les erreurs de réseau
            console.error('Erreur lors de la requête:', error);
            alert('Une erreur de réseau s\'est produite.');
        });
      },

      saveFactView(){
        //Sauvegarder les données dans localStorage
        localStorage.setItem('facture_view', this.facture_view)
      }
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    const moisNodes = document.querySelectorAll('[data-mois]');
    const moisValues = Array.from(moisNodes).map(node => node.getAttribute('data-mois'));    
    const uniqueMois = [...new Set(moisValues)];
    moisNodes.forEach((node, index) => {
      if (moisValues.indexOf(moisValues[index]) !== index) {
        node.style.display = 'none';
      }
    });

    const devMoisNodes = document.querySelectorAll('[data-dev-mois]');
    const devMoisValues = Array.from(devMoisNodes).map(node => node.getAttribute('data-dev-mois'));
    const devUniqueMois = [...new Set(devMoisValues)];
    devMoisNodes.forEach((node, index) => {
      if (devMoisValues.indexOf(devMoisValues[index]) !== index) {
        node.style.display = 'none';
      }
    });
    
    
  });

  document.getElementById('fact_filtre_annee').addEventListener('change', function() {
    var filtreValue = this.value;
    var url = new URL(window.location.href);
    url.searchParams.set('fact_annee', filtreValue);
    window.location.href = url.href;
  });
  document.getElementById('fact_filtre_mois').addEventListener('change', function() {
    var filtreValue = this.value;
    var url = new URL(window.location.href);
    url.searchParams.set('fact_mois', filtreValue);
    window.location.href = url.href;
  });
  document.getElementById('dev_filtre_annee').addEventListener('change', function() {
    var filtreValue = this.value;
    var url = new URL(window.location.href);
    url.searchParams.set('dev_annee', filtreValue);
    window.location.href = url.href;
  });
  document.getElementById('dev_filtre_mois').addEventListener('change', function() {
    var filtreValue = this.value;
    var url = new URL(window.location.href);
    url.searchParams.set('dev_mois', filtreValue);
    window.location.href = url.href;
  });
</script>
{% endblock content %}